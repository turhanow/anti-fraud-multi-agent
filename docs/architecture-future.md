# Будущая архитектура (черновик)

Этот документ фиксирует расширенный объем будущей системы, чтобы реализовать
его после завершения текущего MVP.

## Цели
- Держать кодовую базу сфокусированной на MVP.
- Сохранить целевую архитектуру для масштабирования и работы с временными рядами.

## Целевая архитектура (event-driven)
- Kafka как центральный транспорт.
- Один входящий топик `transactions` с полем `schema_version` в каждом сообщении.
- Orchestrator публикует запросы в `agent.*.requests`.
- Агенты публикуют результаты в `agent.*.results`.
- DecisionAgent потребляет результаты и публикует `decision.results`.

## Временные ряды (time-series enablement)
- Потоковая обработка окон и агрегатов (Kafka Streams или Flink).
- Stateful-слой для окон, профилей и счетчиков.
- Backfill/replay для пересчета истории.

## Хранение и слои данных
- Time-series хранилище: ClickHouse или TimescaleDB.
- State store: RocksDB (через Streams/Flink) или Redis для быстрых чтений.
- Feature Store (опционально) для общих фичей между правилами и ML.

## Наблюдаемость и эксплуатация
- Метрики: Prometheus + Grafana.
- Трассировка: OpenTelemetry.
- Dead-letter топики для неизвестных версий и невалидных событий.

## Этапы внедрения (roadmap)
1) MVP
   - Минимальный Kafka-поток или in-process.
   - Ограниченный набор правил и фичей.
   - Базовая валидация входных сообщений.
2) Kafka-first
   - Агенты как отдельные сервисы.
   - Топики `agent.*.requests` и `agent.*.results`.
   - Корреляция по `analysis_id`.
3) Time-series
   - Потоковые окна и stateful-агенты.
   - Исторические вычисления (backfill).
   - Первые time-series фичи для Velocity/Profile/Geo.
4) ML+Feature Store
   - Общие фичи для агентов и модели.
   - Обновляемые модели и периодический ретрейн.

## Зависимости между этапами
- Kafka-first требует стабильного контракта сообщений и `schema_version`.
- Time-series требует поточного движка и state store.
- ML+Feature Store требует стабильных фичей и исторического хранилища.

## Примечания
- Schema Registry можно добавить позже без смены контракта.
- Документ — ориентир, реализация планируется после MVP.
